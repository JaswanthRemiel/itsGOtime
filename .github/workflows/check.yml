name: itsGOtime

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: itsGOtime-${{ github.run_id }}
  cancel-in-progress: false

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Ensure go modules
        run: |
          go mod tidy
          go list -m all

      - name: Prepare gh-pages folder
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          rm -rf gh-pages

          # If gh-pages exists on remote, clone it
          if git ls-remote --exit-code origin gh-pages; then
            git clone --branch gh-pages --single-branch "https://github.com/${REPO}.git" gh-pages
          else
            # Create gh-pages branch locally
            mkdir gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            echo "<h1>Initial gh-pages branch</h1>" > index.html
            git add index.html
            git commit -m "init gh-pages"
            git remote add origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
            git push -u origin gh-pages
            cd ..
          fi

      - name: Run checker
        run: |
          go run ./cmd/checker
          # status.json is produced in root, history.json in gh-pages/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install --no-frozen-lockfile
        env:
          npm_config_registry: https://registry.npmjs.org/

      - name: Prepare frontend assets
        run: |
          mkdir -p frontend/public
          cp status.json frontend/public/
          if [ -f gh-pages/history.json ]; then
            cp gh-pages/history.json frontend/public/
          elif [ -f history.json ]; then
            cp history.json frontend/public/
          fi

      - name: Build frontend
        working-directory: frontend
        env:
          NEXT_PUBLIC_BASE_PATH: "/${{ github.event.repository.name }}"
          NEXT_TELEMETRY_DISABLED: 1
        run: pnpm run build

      - name: Sync output to gh-pages
        run: |
          # Clean gh-pages but keep .git
          find gh-pages -mindepth 1 -maxdepth 1 -not -name '.git' -exec rm -rf {} +
          
          # Copy build output
          cp -r frontend/out/* gh-pages/
          
          # Create .nojekyll
          touch gh-pages/.nojekyll

      - name: Commit changes to gh-pages
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          cd gh-pages
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .

          if git diff --staged --quiet; then
            echo "no changes"
          else
            git commit -m "Deploy to gh-pages"
            git push "https://x-access-token:${TOKEN}@github.com/${REPO}.git" HEAD:gh-pages
          fi
